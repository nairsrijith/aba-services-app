{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
        <h3 class="mb-4 text-center">My Profile</h3>
        <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
          <div class="row align-items-center g-2 mb-2">
            <div class="col-12 col-md-4 text-center text-md-start">
              {% if current_user.profile_pic %}
                {% set pic = current_user.profile_pic.split('/')[-1] %}
                <img id="profile-preview" src="{{ url_for('profile_pic', filename=pic) }}" alt="Profile" class="img-thumbnail" style="width:128px;height:128px;object-fit:cover;border-radius:12px;" onerror="this.style.display='none'" />
              {% else %}
                <img id="profile-preview" src="" alt="Profile" class="img-thumbnail" style="width:128px;height:128px;object-fit:cover;border-radius:12px;display:none;" />
                <div id="profile-placeholder" class="border rounded" style="width:128px;height:128px;display:inline-block;background:#f6f6f6;line-height:128px;"> </div>
              {% endif %}
            </div>
            <div class="col-12 col-md-8">
              <div class="d-flex flex-column h-100 justify-content-center">
                <label class="form-label" for="profile_pic">{{ form.profile_pic.label.text }}</label>
                {{ form.profile_pic(class="form-control w-100 max-width", id='profile_pic') }}
                <div class="form-text text-start">Upload a profile picture (jpg, png, gif).</div>
                <div class="d-flex justify-content-end mt-2">
                  <button type="submit" name="action" value="update_picture" class="btn btn-secondary">Update Picture</button>
                </div>
              </div>
            </div>
          </div>
          <hr />
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <div class="mb-0">
                {{ form.current_password.label(class="form-label") }}
                {{ form.current_password(class="form-control") }}
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="mb-0">
                {{ form.new_password.label(class="form-label") }}
                {{ form.new_password(class="form-control") }}
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="mb-0">
                {{ form.confirm_password.label(class="form-label") }}
                {{ form.confirm_password(class="form-control") }}
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button type="submit" name="action" value="update_password" class="btn btn-primary">Update Password</button>
          </div>
        </form>
      </div>
    </div>
</div>
{% endblock %}

{# Client-side preview script #}
{% block scripts %}
  <script>
    (function(){
      const input = document.getElementById('profile_pic');
      if (!input) return;
      const preview = document.getElementById('profile-preview');
      const placeholder = document.getElementById('profile-placeholder');
      let objectUrl = null;
      input.addEventListener('change', function(e){
        const f = input.files && input.files[0];
        if (!f) return;
        // Only images
        if (!f.type.startsWith('image/')) return;
        if (objectUrl) {
          URL.revokeObjectURL(objectUrl);
          objectUrl = null;
        }
        objectUrl = URL.createObjectURL(f);
        if (preview) {
          preview.src = objectUrl;
          preview.style.display = 'inline-block';
        }
        if (placeholder) {
          placeholder.style.display = 'none';
        }
      });
    })();
  </script>
{% endblock %}
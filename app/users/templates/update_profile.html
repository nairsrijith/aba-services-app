{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-center">
      <div style="max-width:520px; width:100%;">
        <h3 class="mb-4 text-center">My Profile</h3>
        <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

          <!-- Profile picture card (top) -->
          <div class="card auth-card mb-3">
            <div class="card-body text-center">
              <div class="mb-3">
                {% if current_user.profile_pic %}
                  {% set pic = current_user.profile_pic.split('/')[-1] %}
                  <img id="profile-preview" src="{{ url_for('profile_pic', filename=pic) }}" alt="Profile" class="img-thumbnail mb-2" style="width:128px;height:128px;object-fit:cover;border-radius:12px;" onerror="this.style.display='none'" />
                {% else %}
                  <img id="profile-preview" src="" alt="Profile" class="img-thumbnail mb-2" style="width:128px;height:128px;object-fit:cover;border-radius:12px;display:none;" />
                  <div id="profile-placeholder" class="border rounded mb-2" style="width:128px;height:128px;display:inline-block;background:#f6f6f6;line-height:128px;"> </div>
                {% endif %}
              </div>
              <div class="mb-3 row justify-content-center">
                <div class="col-10 col-md-8">
                  {{ form.profile_pic.label(class="form-label") }}
                  {{ form.profile_pic(class="form-control", id='profile_pic') }}
                  <div class="form-text text-start">Upload a profile picture (jpg, png, gif). Saved to <code>data/profile_pic/</code>.</div>
                </div>
              </div>
              <div class="d-flex justify-content-center">
                <button type="submit" name="action" value="update_picture" class="btn btn-secondary">Update Picture</button>
              </div>
            </div>
          </div>

          <!-- Password card (below) -->
          <div class="card auth-card mb-3">
            <div class="card-body">
              <div class="mb-3">
                {{ form.current_password.label(class="form-label") }}
                {{ form.current_password(class="form-control") }}
              </div>
              <div class="mb-3">
                {{ form.new_password.label(class="form-label") }}
                {{ form.new_password(class="form-control") }}
              </div>
              <div class="mb-3">
                {{ form.confirm_password.label(class="form-label") }}
                {{ form.confirm_password(class="form-control") }}
              </div>
              <div class="d-flex justify-content-end">
                <button type="submit" name="action" value="update_password" class="btn btn-primary">Update Password</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
</div>
{% endblock %}

{# Client-side preview script #}
{% block scripts %}
  <script>
    (function(){
      const input = document.getElementById('profile_pic');
      if (!input) return;
      const preview = document.getElementById('profile-preview');
      const placeholder = document.getElementById('profile-placeholder');
      let objectUrl = null;
      input.addEventListener('change', function(e){
        const f = input.files && input.files[0];
        if (!f) return;
        // Only images
        if (!f.type.startsWith('image/')) return;
        if (objectUrl) {
          URL.revokeObjectURL(objectUrl);
          objectUrl = null;
        }
        objectUrl = URL.createObjectURL(f);
        if (preview) {
          preview.src = objectUrl;
          preview.style.display = 'inline-block';
        }
        if (placeholder) {
          placeholder.style.display = 'none';
        }
      });
    })();
  </script>
{% endblock %}
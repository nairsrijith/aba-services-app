{% extends "base.html" %}
{% block content %}

<div class="container-fluid py-2">
    <h2>Activities</h2>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="row mb-3">
            <div>{{ form.name.label(class="col-form-label") }}{{ form.name(class="form-control", placeholder="Activity Name") }}</div>
            <div>{{ form.category.label(class="col-form-label") }}{{ form.category(class="form-select", placeholder="Activity Category") }}</div> <!-- Select not showing correctly -->
        </div>
        {{ form.submit(class="btn btn-outline-primary") }} <a href="{{ url_for('manage.activities') }}" class="btn btn-secondary ms-2">Clear</a>
    </form>
</div>
<table class="table table-hover">
    <thead>
        <tr>
            <th>Activity</th>
            <th>Category</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% if not activities %}
            <tr><td colspan="3" class="text-center">No activities found.</td></tr>
        {% else %}
            {% for activity in activities %}
                <tr>
                    <td>{{ activity.activity_name }}</td>
                    <td>{{ activity.activity_category }}</td>
                    <td>
                        <!-- The intention is to disable the delete button if the activity is associated with any interventions -->
                        {% if activity.activity_name in allocated_activities %}
                            <button class="btn btn-secondary btn-sm" title="Cannot delete activity with associated interventions" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                            </button>
                        {% else %}
                            <div class="btn-group" role="group" aria-label="Action buttons">
                                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal" data-activity-name="{{ activity.activity_name }}" data-activity-category="{{ activity.activity_category }}" title="Delete Activity">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                                </button>
                            </div>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        {% endif %}
    </tbody>
</table>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteForm" method="POST">
                <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                Are you sure you want to delete activity <strong><span id="activityDelete"></span></strong>?
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var activityName = button.getAttribute('data-activity-name');
        var activityCategory = button.getAttribute('data-activity-category');
        var form = document.getElementById('deleteForm');
        form.action = '/manage/delete_activity/' + activityName;
        document.getElementById('activityDelete').textContent = activityName;
    });
});

function submitRoleForm(actionUrl) {
    // Create a temporary form or use the hidden one
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = actionUrl;
    document.body.appendChild(form);
    form.submit();
}
</script>

{% endblock %}
{% extends "base.html" %}
{% block content %}
<div class="p-2 mb-4 rounded-3">
    <div class="container-fluid py-2">
        <h2>Interventions
            <a href="{{ url_for('interventions.add_intervention') }}" class="btn btn-outline-success mb-3" title="Add New Intervention">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-calendar-plus" viewBox="0 0 16 16">
                    <path d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7"/>
                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                </svg>
            </a>
        </h2>

        <!-- FILTERS AND PER PAGE SELECTOR -->
        <form method="GET" class="mb-3 row g-2 align-items-end">
            <div class="col-md-2">
                <input type="text" name="client" class="form-control" placeholder="Client Name or ID" value="{{ request.args.get('client', '') }}">
            </div>
            <div class="col-md-2">
                <label for="date_from" class="form-label">From:</label>
                <input type="date" id="date_from" name="date_from" class="form-control" value="{{ request.args.get('date_from', '') }}">
            </div>
            <div class="col-md-2">
                <label for="date_to" class="form-label">To:</label>
                <input type="date" id="date_to" name="date_to" class="form-control" value="{{ request.args.get('date_to', '') }}">
            </div>
            <div class="col-md-2">
                <label for="intervention_type" class="form-label">Intervention Type:</label>
                <select name="intervention_type" id="intervention_type" class="form-select">
                    <option value="" {% if request.args.get('intervention_type', '') == '' %}selected{% endif %}>All</option>
                    {% for activity in activities %}
                        <option value="{{ activity.activity_name }}"
                            {% if request.args.get('intervention_type', '') == activity.activity_name %}selected{% endif %}>
                            {{ activity.activity_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="invoiced" class="form-label">Invoiced:</label>
                <select name="invoiced" id="invoiced" class="form-select">
                    <option value="" {% if request.args.get('invoiced', '') == '' %}selected{% endif %}>All</option>
                    <option value="no" {% if request.args.get('invoiced', '') == 'no' %}selected{% endif %}>No</option>
                    <option value="yes" {% if request.args.get('invoiced', '') == 'yes' %}selected{% endif %}>Yes</option>
                </select>
            </div>
            <div class="col-md-1">
                <label for="per_page" class="form-label">Rows:</label>
                <select name="per_page" id="per_page" class="form-select w-auto" onchange="this.form.submit()">
                    <option value=5 {% if per_page == 5 %}selected{% endif %}>5</option>
                    <option value=10 {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value=20 {% if per_page == 20 %}selected{% endif %}>20</option>
                </select>
            </div>
            <div class="col">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
                        <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2z"/>
                    </svg>
                </button>
                <a href="{{ url_for('interventions.list_interventions') }}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                </a>
            </div>
            <input type="hidden" name="page" value="1">
        </form>

        <!-- BULK DELETE FORM AND TABLE -->
        <form method="POST" action="{{ url_for('interventions.bulk_delete') }}">
            <button type="submit" class="btn btn-danger mb-2" id="bulk-delete-btn" disabled onclick="return confirm('Delete selected interventions?')" title="Delete Selected Interventions">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                    <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5"/>
                </svg>
            </button>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Client Name</th>
                        <th>Employee Name</th>
                        <th>Intervention Type</th>
                        <th>Date</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Duration(hrs)</th>
                        <th>Invoice Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% if not interventions %}
                    <tr>
                        <td colspan="10" class="text-center">No interventions found.</td>
                    </tr>
                {% else %}
                    {% for intervention in interventions %}
                        <tr>
                            <td>
                                {% if not intervention.invoiced %}
                                    <input type="checkbox" name="selected_ids" value="{{ intervention.id }}">
                                {% endif %}
                            </td>
                            <td>{{ intervention.client.firstname }} {{ intervention.client.lastname }}</td>
                            <td>{{ intervention.employee.firstname }} {{ intervention.employee.lastname }}</td>
                            <td>{{ intervention.intervention_type }}</td>
                            <td>{{ intervention.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ intervention.start_time.strftime('%H:%M') }}</td>
                            <td>{{ intervention.end_time.strftime('%H:%M') }}</td>
                            <td>{{ '%.2f' % intervention.duration }}</td>
                            <td>{{ intervention.invoice_number if intervention.invoice_number else 'N/A' }}</td>
                            <td>
                                {% if not intervention.invoiced %}
                                    <a href="{{ url_for('interventions.update_intervention', intervention_id=intervention.id) }}" class="btn btn-primary btn-sm" title="Edit Intervention">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16">
                                            <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/>
                                        </svg>
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}
                </tbody>
            </table>
        </form>

        <!-- PAGINATION -->
        <nav>
            <ul class="pagination justify-content-end">
                {# Previous #}
                {% set prev_args = request.args.to_dict() %}
                {% set _ = prev_args.update({'page': pagination.prev_num, 'per_page': per_page}) %}
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('interventions.list_interventions', **prev_args) }}">Previous</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                {# Page numbers #}
                {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if p %}
                        {% set page_args = request.args.to_dict() %}
                        {% set _ = page_args.update({'page': p, 'per_page': per_page}) %}
                        {% if p == pagination.page %}
                            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="{{ url_for('interventions.list_interventions', **page_args) }}">{{ p }}</a></li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">â€¦</span></li>
                    {% endif %}
                {% endfor %}

                {# Next #}
                {% set next_args = request.args.to_dict() %}
                {% set _ = next_args.update({'page': pagination.next_num, 'per_page': per_page}) %}
                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('interventions.list_interventions', **next_args) }}">Next</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
            </ul>
        </nav>

        <script>
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('input[name="selected_ids"]');
            for (const cb of checkboxes) {
                cb.checked = this.checked;
            }
            updateDeleteButton();
        });

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('input[name="selected_ids"]');
            const deleteBtn = document.getElementById('bulk-delete-btn');
            let anyChecked = false;
            for (const cb of checkboxes) {
                if (cb.checked) {
                    anyChecked = true;
                    break;
                }
            }
            deleteBtn.disabled = !anyChecked;
        }

        // Attach event listeners to all checkboxes
        document.querySelectorAll('input[name="selected_ids"]').forEach(cb => {
            cb.addEventListener('change', updateDeleteButton);
        });

        // Initial state
        updateDeleteButton();
        </script>
    </div>
</div>
{% endblock %}
{% extends "base.html" %}
{% block content %}
<div class="p-2 mb-4 rounded-3">
    <div class="container-fluid py-2">
        <h2>Sessions
            <a href="{{ url_for('interventions.add_intervention') }}" title="Add New Session">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-280h80v-160h160v-80H520v-160h-80v160H280v80h160v160ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0-560v560-560Z"/></svg>
            </a>
        </h2>

        <!-- FILTERS AND PER PAGE SELECTOR -->
        <form method="GET" class="mb-3 row g-2 align-items-end">
            <div class="col-md-2">
                <input type="text" name="client" class="form-control" placeholder="Client Name" value="{{ request.args.get('client', '') }}">
            </div>
            <div class="col-md-2">
                <label for="date_from" class="form-label">From:</label>
                <input type="date" id="date_from" name="date_from" class="form-control" value="{{ request.args.get('date_from', '') }}">
            </div>
            <div class="col-md-2">
                <label for="date_to" class="form-label">To:</label>
                <input type="date" id="date_to" name="date_to" class="form-control" value="{{ request.args.get('date_to', '') }}">
            </div>
            <div class="col-md-2">
                <label for="intervention_type" class="form-label">Session Type:</label>
                <select name="intervention_type" id="intervention_type" class="form-select">
                    <option value="" {% if request.args.get('intervention_type', '') == '' %}selected{% endif %}>All</option>
                    {% for activity in activities %}
                        <option value="{{ activity.activity_name }}"
                            {% if request.args.get('intervention_type', '') == activity.activity_name %}selected{% endif %}>
                            {{ activity.activity_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="invoiced" class="form-label">Invoiced:</label>
                <select name="invoiced" id="invoiced" class="form-select">
                    <option value="" {% if request.args.get('invoiced', '') == '' %}selected{% endif %}>All</option>
                    <option value="no" {% if request.args.get('invoiced', '') == 'no' %}selected{% endif %}>No</option>
                    <option value="yes" {% if request.args.get('invoiced', '') == 'yes' %}selected{% endif %}>Yes</option>
                </select>
            </div>
            <div class="col-md-1">
                <label for="per_page" class="form-label">Rows:</label>
                <select name="per_page" id="per_page" class="form-select w-auto" onchange="this.form.submit()">
                    <option value=5 {% if per_page == 5 %}selected{% endif %}>5</option>
                    <option value=10 {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value=20 {% if per_page == 20 %}selected{% endif %}>20</option>
                </select>
            </div>
            <div class="col">
                <button type="submit" class="btn btn-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-160q-17 0-28.5-11.5T400-200v-240L168-736q-15-20-4.5-42t36.5-22h560q26 0 36.5 22t-4.5 42L560-440v240q0 17-11.5 28.5T520-160h-80Zm40-308 198-252H282l198 252Zm0 0Z"/></svg>
                </button>
                <a href="{{ url_for('interventions.list_interventions') }}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M690-240h190v80H610l80-80Zm-500 80-85-85q-23-23-23.5-57t22.5-58l440-456q23-24 56.5-24t56.5 23l199 199q23 23 23 57t-23 57L520-160H190Zm296-80 314-322-198-198-442 456 64 64h262Zm-6-240Z"/></svg>
                </a>
            </div>
            <input type="hidden" name="page" value="1">
        </form>

        <!-- BULK DELETE FORM AND TABLE -->
        <form method="POST" action="{{ url_for('interventions.bulk_delete') }}">
            <button type="submit" class="btn btn-danger mb-2" id="bulk-delete-btn" disabled onclick="return confirm('Delete selected sessions?')" title="Delete Selected Sessions">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
            </button>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Client Name</th>
                        <th>Employee Name</th>
                        <th>Session Type</th>
                        <th class="text-end">Date</th>
                        <th class="text-end">Start Time</th>
                        <th class="text-end">End Time</th>
                        <th class="text-end">Duration(hrs)</th>
                        <th class="text-center">Payroll State</th>
                        <th>Invoice Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% if not interventions %}
                        <tr>
                        <td colspan="11" class="text-center">No sessions found.</td>
                    </tr>
                {% else %}
                    {% for intervention in interventions %}
                        <tr>
                            <td>
                                {% if not intervention.invoiced and not intervention.is_paid %}
                                    <input type="checkbox" name="selected_ids" value="{{ intervention.id }}">
                                {% else %}
                                    {# show a disabled checkbox so user sees why it can't be selected #}
                                    <input type="checkbox" disabled
                                        title="{% if intervention.is_paid %}Paid sessions cannot be deleted{% else %}Invoiced sessions cannot be deleted{% endif %}">
                                {% endif %}
                            </td>
                            <td>{{ intervention.client.firstname }} {{ intervention.client.lastname }}</td>
                            <td>{{ intervention.employee.firstname }} {{ intervention.employee.lastname }}</td>
                            <td>{{ intervention.intervention_type }}</td>
                            <td class="text-end">{{ intervention.date.strftime('%Y-%m-%d') }}</td>
                            <td class="text-end">{{ intervention.start_time.strftime('%H:%M') }}</td>
                            <td class="text-end">{{ intervention.end_time.strftime('%H:%M') }}</td>
                            <td class="text-end">{{ "%.2f"|format(intervention.duration|float) }}</td>
                            <td class="text-center">
                                {% if intervention.is_paid %}
                                    <span class="badge bg-success">Paid</span>
                                {% else %}
                                    <span class="badge bg-secondary">Unpaid</span>
                                {% endif %}
                            </td>
                            <td>
                                {%- if intervention.invoice -%}
                                    {%- set inv_status = intervention.invoice.status -%}
                                        {%- if inv_status == 'Draft' -%}
                                            <span class="badge bg-info" title="{{ inv_status }}">{{ intervention.invoice_number }}</span>
                                        {%- elif inv_status == 'Sent' -%}
                                            <span class="badge bg-warning text-dark" title="{{ inv_status }}">{{ intervention.invoice_number }}</span>
                                        {%- elif inv_status == 'Paid' -%}
                                            <span class="badge bg-success" title="{{ inv_status }}">{{ intervention.invoice_number }}</span>
                                        {%- else -%}
                                            <span class="badge bg-secondary" title="{{ inv_status }}">{{ intervention.invoice_number }}</span>
                                    {%- endif -%}
                                {%- else -%}
                                    <span class="badge bg-secondary" title="Not invoiced">N/A</span>
                                {%- endif -%}
                            </td>
                            <td>
                                {% if not intervention.invoiced and not intervention.is_paid %}
                                    <a href="{{ url_for('interventions.update_intervention', intervention_id=intervention.id) }}" class="btn btn-primary btn-sm" title="Edit Session">Edit</a>
                                {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled title="{% if intervention.is_paid %}Paid sessions cannot be edited{% else %}Invoiced sessions cannot be edited{% endif %}">
                                        Edit
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}
                </tbody>
            </table>
        </form>

        <!-- PAGINATION -->
        <nav>
            <ul class="pagination justify-content-end">
                {# Previous #}
                {% set prev_args = request.args.to_dict() %}
                {% set _ = prev_args.update({'page': pagination.prev_num, 'per_page': per_page}) %}
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('interventions.list_interventions', **prev_args) }}">Previous</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                {# Page numbers #}
                {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if p %}
                        {% set page_args = request.args.to_dict() %}
                        {% set _ = page_args.update({'page': p, 'per_page': per_page}) %}
                        {% if p == pagination.page %}
                            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="{{ url_for('interventions.list_interventions', **page_args) }}">{{ p }}</a></li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">â€¦</span></li>
                    {% endif %}
                {% endfor %}

                {# Next #}
                {% set next_args = request.args.to_dict() %}
                {% set _ = next_args.update({'page': pagination.next_num, 'per_page': per_page}) %}
                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('interventions.list_interventions', **next_args) }}">Next</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
            </ul>
        </nav>

        <script>
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('input[name="selected_ids"]');
            for (const cb of checkboxes) {
                cb.checked = this.checked;
            }
            updateDeleteButton();
        });

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('input[name="selected_ids"]');
            const deleteBtn = document.getElementById('bulk-delete-btn');
            let anyChecked = false;
            for (const cb of checkboxes) {
                if (cb.checked) {
                    anyChecked = true;
                    break;
                }
            }
            deleteBtn.disabled = !anyChecked;
        }

        // Attach event listeners to all checkboxes
        document.querySelectorAll('input[name="selected_ids"]').forEach(cb => {
            cb.addEventListener('change', updateDeleteButton);
        });

        // Initial state
        updateDeleteButton();
        </script>
    </div>
</div>
{% endblock %}
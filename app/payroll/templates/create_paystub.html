{% extends 'base.html' %}
{% block content %}
<div class="p-2 mb-4 rounded-3 container-fluid">
  <h2>Create Paystub</h2>
  <form method="POST">
    {{ form.hidden_tag() }}
    <div class="row mb-3">
      <div>{{ form.employee.label }}{{ form.employee(class="form-select") }}</div>
      <div>{{ form.start_date.label }}{{ form.start_date(class="form-control", type="date") }}</div>
      <div>{{ form.end_date.label }}{{ form.end_date(class="form-control", type="date") }}</div>
    </div>
    <div class="col-auto">
      {{ form.submit(class="btn btn-outline-primary") }}
      {% if preview %}
        <button name="save" value="1" class="btn btn-primary ms-2">Save Paystub</button>
      {% endif %}
      <a href="{{ url_for('payroll.list_paystubs') }}" class="btn btn-secondary ms-2">Cancel</a>
    </div>
  </form>

  {% if preview %}
    <hr>
    <h4>Preview for {{ preview.employee.firstname }} {{ preview.employee.lastname }} ({{ preview.start }} - {{ preview.end }})</h4>
    <table class="table table-dark table-hover mt-2">
      <thead>
        <tr><th>Date</th><th>Client</th><th>Activity</th><th>Hours</th><th>Rate</th><th>Amount</th></tr>
      </thead>
      <tbody>
        {% for ln in preview.lines %}
          <tr>
            <td>{{ ln.intervention.date }}</td>
            <td>{{ ln.client.firstname }} {{ ln.client.lastname }}</td>
            <td>{{ ln.intervention.intervention_type }}</td>
            <td>{{ ln.hours }}</td>
            <td>{{ ln.rate }}</td>
            <td>{{ ln.amount }}</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr><td colspan="3"></td><td>{{ preview.total_hours }}</td><td></td><td>{{ preview.total_amount }}</td></tr>
      </tfoot>
    </table>
  {% endif %}

  {% if missing_rates %}
    <div class="alert alert-danger mt-3">Missing pay rates for some sessions' clients. Add pay rates in Manage or Payroll before saving.</div>
  {% endif %}
</div>
{% endblock %}
